# GBA Codebase Overview

GBA (Geektime Bootcamp Agent) is an AI-powered development automation tool built in Rust. It uses the Claude Agent SDK to drive a structured software development workflow: initialize a repository, interactively plan features as phased specs, and execute those specs automatically with coding, code review, verification, and PR creation -- all orchestrated by multiple specialized Claude agents.

## Directory Structure

```
.
├── apps/
│   └── gba-cli/            # CLI binary crate (entry point: `gba`)
├── crates/
│   ├── gba-core/            # Core execution engine (orchestrates agents, git, hooks)
│   └── gba-pm/              # Prompt manager (Jinja2 template loading and rendering)
├── agents/                  # Jinja2 prompt templates and agent configs (embedded at compile time)
│   ├── init/                # Repo analyzer agent (preset: true)
│   ├── plan/                # Architect/planner agent (preset: true)
│   ├── code/                # Developer agent (preset: true) -- task, resume, hook_fix, pr
│   ├── review/              # Code reviewer agent (preset: false, pure text analysis)
│   └── verify/              # QA/tester agent (preset: true)
├── vendors/
│   └── claude-agent-sdk-rs/ # Vendored Claude Agent SDK for Rust (git submodule)
├── specs/                   # Design specifications
├── .gba/                    # GBA project config (config.yaml)
├── .github/workflows/       # CI (build, fmt, clippy, test, release via git-cliff)
├── Cargo.toml               # Workspace root
├── deny.toml                # cargo-deny license/ban policy
├── cliff.toml               # git-cliff changelog config
└── rust-toolchain.toml      # Pinned Rust 1.92.0
```

## Languages, Frameworks, and Build Tools

- **Language**: Rust 2024 edition, pinned to stable 1.92.0 via `rust-toolchain.toml`
- **Async runtime**: Tokio (full features)
- **AI SDK**: `claude-agent-sdk-rs` (vendored submodule) -- wraps Claude Code CLI for agent sessions
- **Template engine**: minijinja (Jinja2-compatible) for prompt template rendering
- **CLI**: clap (derive) for argument parsing
- **TUI**: ratatui + crossterm (scaffolded, not yet fully implemented)
- **Serialization**: serde + serde_yaml (config/specs) + serde_json (agent context)
- **Error handling**: thiserror (library errors), anyhow (application errors)
- **Builder pattern**: typed-builder for `EngineConfig`
- **Logging**: tracing + tracing-subscriber with env-filter
- **CI**: GitHub Actions -- fmt check, clippy, tests, git-cliff changelog, GitHub Releases
- **Dependency policy**: cargo-deny (`deny.toml`) for license allow-listing and ban enforcement

## Workspace Layout

Cargo workspace with `resolver = "3"`. Members: `crates/*`, `apps/*`. Dependencies are centralized in `[workspace.dependencies]`.

### `gba-cli` (apps/gba-cli)

Binary crate producing the `gba` executable. Entry point: `src/main.rs`.

**Modules:**
- `cli` -- Clap command definitions (`Init`, `Plan`, `Run`) and dispatch to engine workflows
- `tui` -- Placeholder ratatui `App` struct for future interactive TUI

**Commands:**
- `gba init [--repo PATH]` -- Initialize a repository for GBA
- `gba plan <slug> [--repo PATH] [--model MODEL]` -- Interactive planning session
- `gba run <slug> [--repo PATH] [--model MODEL]` -- Execute feature plan phase by phase

### `gba-core` (crates/gba-core)

Core execution engine. Orchestrates agent sessions, git operations, and hook execution.

**Public API:**
- `Engine` -- Main entry point. Created via `Engine::new(EngineConfig)`. Methods: `init()`, `plan(slug)`, `run(slug)`
- `EngineConfig` -- CLI-level configuration (repo_path, model override, max_tokens). Built with typed-builder
- `ProjectConfig` -- Deserialized from `.gba/config.yaml`. Sub-configs: `AgentProjectConfig`, `PromptsConfig`, `GitConfig`, `ReviewConfig`, `VerificationConfig`, `HooksConfig`, `Hook`
- `PlanSession` -- Bidirectional handle for interactive planning (channels: event_rx, input_tx)
- `PlanEvent` -- Events from plan agent: `Message`, `WaitingForInput`, `SpecGenerated`, `Completed`, `Error`
- `RunStream` -- Unidirectional handle for run progress events
- `RunEvent` -- Events from run execution: `Started`, `PhaseStarted`, `CodingOutput`, `HookResult`, `PhaseCommitted`, `ReviewStarted`, `ReviewCompleted`, `VerificationStarted`, `VerificationCompleted`, `PrCreated`, `Finished`, `Error`
- `FeatureSpec` -- Feature spec data model serialized as `phases.yaml`. Contains `Phase`, `PhaseResult`, `StepStatus`, `VerificationPlan`, `Execution`, `ReviewResult`, `VerificationResult`
- `CoreError` -- Unified error enum: `NotInitialized`, `AlreadyInitialized`, `FeatureNotFound`, `InvalidSpec`, `Agent`, `Git`, `Config`, `Hook`, `Prompt`, `Yaml`, `Io`, `Other`
- `Issue`, `Severity` -- Code review issue types

**Internal modules (private):**
- `agent` -- `AgentRunner` wraps claude-agent-sdk-rs. Builds `ClaudeAgentOptions` from agent config, renders system prompts, supports both collecting (`run_agent`) and streaming (`run_agent_stream`) modes
- `git` -- `GitOps` manages git worktrees, branches, commits, diffs via `tokio::process::Command`
- `hooks` -- `HookRunner` executes precommit shell commands, captures stdout/stderr
- `spec` -- File I/O for `phases.yaml`, `design.md`, `verification.md`
- `init` -- Init workflow: creates `.gba/`, `.trees/`, generates repo tree, calls init agent
- `plan` -- Plan workflow: spawns `ClaudeClient` for bidirectional streaming, emits `PlanEvent`s
- `run` -- Run workflow: phase loop, hook cycle, review cycle, verification cycle, PR creation. Supports resume by reading `phases.yaml` status

### `gba-pm` (crates/gba-pm)

Prompt template management. Loads built-in Jinja2 templates at compile time, supports runtime overrides.

**Public API:**
- `PromptManager` -- Loads and renders templates. `new()` loads built-in templates (embedded via `include_str!`). `load_dir(path)` loads custom overrides. `render(name, ctx)` renders with serde_json context. `load_agent_config(name)` loads agent `config.yml`
- `AgentConfig` -- Agent config from `config.yml`: `preset` (bool), `tools` (Vec<String>), `disallowed_tools` (Vec<String>)
- `PromptTemplate` -- Template metadata (name + source)
- `PmError` -- Error enum: `TemplateNotFound`, `RenderError`, `InvalidTemplate`, `Io`, `ConfigParse`

**Template naming convention:** `{agent_name}/{template_name}` (e.g., `code/task`, `review/system`). Built-in templates are in `agents/` at workspace root. Custom overrides use the same relative paths.

## Key Conventions and Patterns

### Agent System
Five specialized agents, each defined in `agents/{name}/`:
- **init** (preset) -- Analyzes repo structure, generates `.gba.md` context document
- **plan** (preset) -- Interactive architect for feature planning; produces `design.md`, `verification.md`, `phases.yaml`
- **code** (preset) -- Developer agent; implements phases, fixes hooks, fixes review/verification issues, creates PRs
- **review** (non-preset) -- Text-only code reviewer; receives diff in prompt, no tool access
- **verify** (preset) -- Runs test commands and checks verification criteria

`preset: true` means the agent uses Claude Code's built-in tools (file read/write, bash, etc.). `preset: false` means pure text analysis with no tools.

### Configuration Hierarchy
CLI flags (`EngineConfig`) override project config (`.gba/config.yaml` -> `ProjectConfig`). Config is loaded in `Engine::new()`.

### Data Flow
1. `gba init` -> creates `.gba/config.yaml`, `.trees/`, `.gba.md`, updates `CLAUDE.md`
2. `gba plan <slug>` -> creates `.gba/features/<slug>/specs/` with `design.md`, `verification.md`, `phases.yaml`; creates git worktree in `.trees/<slug>`
3. `gba run <slug>` -> loads `phases.yaml`, executes each phase via code agent, runs precommit hooks (with retry), performs code review (with fix iterations), runs verification (with fix iterations), creates PR. Saves `phases.yaml` after each phase for resume support

### Serialization
- YAML with `#[serde(rename_all = "camelCase")]` for config and spec files
- JSON for agent context variables passed to templates
- `skip_serializing_if = "Option::is_none"` for optional fields

### Error Handling
- Library crates use `thiserror` with domain-specific error enums (`CoreError`, `PmError`)
- Application crate (`gba-cli`) uses `anyhow` with `.context()` for error propagation
- `Result<T, CoreError>` for all fallible core operations

### Testing
- Unit tests in `#[cfg(test)] mod tests` within each source file
- Test names use `test_should_` prefix describing behavior
- `tempfile` for filesystem test fixtures
- `tokio::test` for async tests

### Git Workflow
- Feature work happens in git worktrees under `.trees/<slug>`
- Branch naming from config pattern: `feat/{id}-{slug}` (default)
- Auto-commit after each phase with message format: `feat(<slug>): phase N - <name>`

### Logging
- `tracing` with `#[instrument]` on key functions
- Log levels: `info!` for workflow milestones, `debug!` for internal state, `warn!` for recoverable issues, `error!` for failures
